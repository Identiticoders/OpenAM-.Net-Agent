language: csharp
git:
  depth: 9999
matrix:
  include:
  - os: linux
    sudo: required
    services:
      - docker
    before_deploy: 
      - git config --local user.name "Open Identity Platform Community" && git config --local user.email "open-identity-platform-openam@googlegroups.com"
      - git checkout -f $TRAVIS_BRANCH
      - git tag -f $git_version
      - xbuild /p:Configuration=Release ru.org.openam.dotnet.sln
      - cp ru.org.openam.iis.httpmodule/Properties/AssemblyInfo.cs ru.org.openam.iis.httpmodule/bin/Release/ru.org.openam.version.txt
      - cat ru.org.openam.iis.httpmodule/bin/Release/ru.org.openam.version.txt
      - zip -rjv  /tmp/ru.org.openam.iis.httpmodule.zip ru.org.openam.iis.httpmodule/bin/Release/* 
      - git push --quiet --force https://$GITHUBKEY@github.com/$TRAVIS_REPO_SLUG.git $git_version >/dev/null 2>&1
    deploy:
      provider: releases
      draft: false
      prerelease: false
      target_commitish: $(git rev-list -n 1 $git_version)
      tag_name: $git_version
      name: $git_version
      body: "compare: $(git rev-list -n 1 $git_version_last)...$(git rev-list -n 1 $git_version)"
      api_key:
       secure: SjVM74aEOKoFNVcs1EifBIz6VoABrUWB358VRX3hc7Fakvq1p7Ze3lQ99PTXIwoaf4K3d4kwxe/KJjhKq/imDgcjyeRoqEsIPj3ijPnjM6ew5Ic2v+lV+vxjgdgFUOFNUZ/TXn+KepPtsFEOeZbJ2O5CHm2dBXFUztlT+GN2UfY2Xarr3ek2rs7l95+YLoCgN4GhkXvQDKSEtpWxxSG/C3WH3kS6KqAMu+sAQy6FBqGNbEz7fMvoVhqeq5F0pvczJKaKuxAmk0OJFaydQH8rpC1s19JVmu5SN9sVRjkj8gj2Q1cAxIn1v96DDNgSmGmD3KptucWzP06AxsZs2lajjSJc72Lf75hZ8/u/W0e9Kc4sMj5lo4NWdGS0o5J5JEmP62ds1k9f6OIr5EEsRKz7I5W9pufcECLCKDPc/wCOoLxj+X4xuTzoXLmTqpo7LlLbHtmboHcLHrZPpbtLneqhWOHzUq55uC+tHAa+IDDpYAO+SbKbeMgtLModwaP0m8FFmM2MZhfjXzxlDnPpxLPIAtu8dsdW9Y3thXBLQEXBg50B2Bsadh2TDowGFq+ZMadRTx85+WyI6fETxlMayb1wpozYixFOzqokRsqX+dGgLe9H7zMm5u5+SyMMlWR76iW4KtZWuuqwg86lBHh5MVd8vNmv4yRu4cY3YvrFguHixhA=
      skip_cleanup: true
      overwrite: true
      file_glob: true
      file: 
        - "/tmp/ru.org.openam.iis.httpmodule.zip"
      on:
        repo: OpenIdentityPlatform/OpenAM-.Net-Agent
        tags: false
        branch: 
          - master
          - travis
    after_deploy:
      - echo 'after_deploy'
  - os: osx
before_install:
 - date -u
 - uname -a
 - export PATH=/opt/mono/bin:$PATH
 - # if [[ "$TRAVIS_OS_NAME" == "osx" ]] ; then brew install rpm wine; else sudo apt-get install -y rpm wine; fi
 - git fetch -t
 - export git_version_last="$(git describe --abbrev=0 --tags --always)"
 - export git_version="$(echo $git_version_last | awk -F . '{ printf "%d.%d.%d", $1,$2,$3 + 1}')"
 - env | sort
 - git log `git describe --tags --abbrev=0 HEAD^ --always`..HEAD --oneline
solution: ru.org.openam.dotnet.sln
branches:
  except:
    - /[0-9]+\.[0-9]+\.[0-9]+$/
notifications:
 email:
  - open-identity-platform-openam@googlegroups.com
install:
  - nuget restore ru.org.openam.dotnet.sln
  - nuget install NUnit.Runners -Version 3.8.0 -OutputDirectory testrunner
script:
  - git fetch -t
  - xbuild /p:Configuration=Debug ru.org.openam.dotnet.sln
  - mono ./testrunner/NUnit.ConsoleRunner.3.8.0/tools/nunit3-console.exe ./ru.org.openam.nunit/bin/Debug/ru.org.openam.sdk.nunit.dll
